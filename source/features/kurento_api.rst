===========
Kurento API
===========

.. contents:: Table of Contents

**Kurento Media Server** can be controlled through the API it exposes, so application developers can use high level languages to interact with it. The Kurento project already provides :doc:`Kurento Client </features/kurento_client>` implementations of this API for several platforms.

If you prefer a programming language different from the supported ones, you can implement your own Kurento Client by using the :doc:`Kurento Protocol</features/kurento_protocol>`, which is based on :term:`WebSocket` and :term:`JSON-RPC`.

In the following sections we will describe the Kurento API from a high-level point of view, showing the media capabilities exposed by Kurento Media Server to clients. If you want to see working demos using Kurento, please refer to the :doc:`Tutorials section </user/tutorials>`.



Media Elements and Media Pipelines
==================================

Kurento is based on two concepts that act as building blocks for application developers:

- **Media Elements**. A Media Element is a functional unit performing a specific action on a media stream. Media Elements are a way of every capability is represented as a self-contained "black box" (the Media Element) to the application developer, who does not need to understand the low-level details of the element for using it. Media Elements are capable of *receiving* media from other elements (through media sources) and of *sending* media to other elements (through media sinks). Depending on their function, Media Elements can be split into different groups:

  - **Input Endpoints**: Media Elements capable of receiving media and injecting it into a pipeline. There are several types of input endpoints. File input endpoints take the media from a file, Network input endpoints take the media from the network, and Capture input endpoints are capable of capturing the media stream directly from a camera or other kind of hardware resource.
  - **Filters**: Media Elements in charge of transforming or analyzing media. Hence there are filters for performing operations such as mixing, muxing, analyzing, augmenting, etc.
  - **Hubs**: Media Objects in charge of managing multiple media flows in a pipeline. A Hub has several hub ports where other Media Elements are connected. Depending on the Hub type, there are different ways to control the media. For example, there are a Hub called Composite that merge all input video streams in a unique output video stream with all inputs in a grid.
  - **Output Endpoints**: Media Elements capable of taking a media stream out of the pipeline. Again, there are several types of output endpoints specialized in files, network, screen, etc.

- **Media Pipeline**: A Media Pipeline is a chain of Media Elements, where the output stream generated by one element (source) is fed into one or more other elements input streams (sinks). Hence, the pipeline represents a "machine" capable of performing a sequence of operations over a stream.

  .. figure:: /images/kurento-java-tutorial-2-magicmirror-pipeline.png
     :align:  center
     :alt:    Media Pipeline example

     *Example of a Media Pipeline implementing an interactive multimedia application receiving media from a WebRtcEndpoint, overlaying and image on the detected faces and sending back the resulting stream*

Kurento API is an object-oriented API. That is, there are classes that can be instantiated. This classes define operations that can be invoked over objects of this classes. The classes can have an inheritance relationship with other classes, inheriting operations from parent classes to children ones.

The following class diagram shows some of the relationships of the main classes in the Kurento API:

.. figure:: /images/digraphs/Media_Objects.png
   :align: center
   :alt:   Class diagram of main classes in Kurento API

   *JJ1 Class diagram of main classes in Kurento API*

.. digraph:: Media_Objects
   :align: center
   :caption: JJ2 Class diagram of main classes in Kurento API

   size="12,8";
   fontname = "Bitstream Vera Sans"
   fontsize = 8

   node [
        fontname = "Bitstream Vera Sans"
        fontsize = 8
        shape = "record"
         style=filled
        fillcolor = "#E7F2FA"
   ]

   edge [
        fontname = "Bitstream Vera Sans"
        fontsize = 8
        arrowtail = "empty"
        dir = back;
   ]

   MediaObject [
        label = "{MediaObject|" +
                "+ getMediaPipeline() : MediaPipeline\l" +
                "+ getParent() : MediaObject[]\l}"
        labelurl = "MediaObject"
        href = "com/kurento/kmf/media/MediaObject.html"
   ]

   MediaElement [
        label = "{MediaElement|" +
                "+ connect(...) : void\l" +
                "+ getMediaSinks(...) : MediaSink[]\l" +
                "+ getMediaSrcs(...) : MediaSource[]\l}"
        urllabel = "MediaElement"
        href = "com/kurento/kmf/media/MediaElement.html"
   ]


   MediaObject -> MediaPipeline;
   MediaObject -> MediaElement;
   MediaObject -> Hub;

   MediaObject -> MediaObject [label = "parent", constraint=false, dir = normal, arrowhead="vee"]

   MediaObject -> MediaPipeline [label = "pipeline", constraint=false, dir = normal, arrowhead="vee"]

   MediaPipeline -> MediaElement [headlabel="*" label = "elements", constraint=false, dir = normal, arrowhead="vee"]

   MediaElement -> Endpoint;
   MediaElement -> Filter;
   MediaElement -> HubPort;

   "Hub" -> "HubPort" [headlabel = "*", constraint=false, dir = normal, arrowhead="vee"]



Endpoints
=========

A **WebRtcEndpoint** is an input/output endpoint that provides media streaming for Real Time Communications (RTC) through the web. It implements :term:`WebRTC` technology to communicate with browsers.

.. image:: /images/toolbox/WebRtcEndpoint.png
   :align:  center

An **RtpEndpoint** is an input/output endpoint that provides bidirectional content delivery capabilities with remote networked peers, through the :term:`RTP` protocol. It uses :term:`SDP` for media negotiation.

.. image:: /images/toolbox/RtpEndpoint.png
   :align:  center

An **HttpPostEndpoint** is an input endpoint that accepts media using HTTP POST requests like HTTP file upload function.

.. image:: /images/toolbox/HttpPostEndpoint.png
   :align:  center

A **PlayerEndpoint** is an input endpoint that retrieves content from file system, HTTP URL or RTSP URL and injects it into the Media Pipeline.

.. image:: /images/toolbox/PlayerEndpoint.png
   :align:  center

A **RecorderEndpoint** is an output endpoint that provides function to store contents in reliable mode (doesn't discard data). It contains ``Media Sink`` pads for audio and video.

.. image:: /images/toolbox/RecorderEndpoint.png
   :align:  center

The following class diagram shows the relationships of the main endpoint classes:

.. figure:: /images/digraphs/Endpoints.png
   :align: center
   :alt:   Class diagram of main Endpoints in Kurento API

   *JJ3 Class diagram of main Endpoints in Kurento API*

.. digraph:: Endpoints
   :align: center
   :caption: JJ4 Class diagram of Endpoints in Kurento API

   size="12,8";
   fontname = "Bitstream Vera Sans"
   fontsize = 8

   node [
        fontname = "Bitstream Vera Sans"
        fontsize = 8
        shape = "record"
         style=filled
        fillcolor = "#E7F2FA"
   ]

   edge [
        fontname = "Bitstream Vera Sans"
        fontsize = 8
        arrowtail = "empty"
        dir = back;
   ]

   "MediaElement" -> "Endpoint";
   Endpoint -> SessionEndpoint;
   Endpoint -> UriEndpoint;

   SessionEndpoint -> HttpEndpoint;
   SessionEndpoint -> SdpEndpoint;

   HttpEndpoint -> HttpPostEndpoint;

   SdpEndpoint -> RtpEndpoint;
   SdpEndpoint -> WebRtcEndpoint;

   UriEndpoint -> PlayerEndpoint;
   UriEndpoint -> RecorderEndpoint;



Filters
=======

Filters are MediaElements that perform media processing, Computer Vision, Augmented Reality, and so on.

The **ZBarFilter** filter detects QR and bar codes in a video stream. When a code is found, the filter raises a ``CodeFoundEvent``. Clients can add a listener to this event to execute some action.

.. image:: /images/toolbox/ZBarFilter.png
   :align:  center

The **FaceOverlayFilter** filter detects faces in a video stream and overlaid it with a configurable image.

.. image:: /images/toolbox/FaceOverlayFilter.png
   :align:  center

**GStreamerFilter** is a generic filter interface that allow use GStreamer filter in Kurento Media Pipelines.

.. image:: /images/toolbox/GStreamerFilter.png
   :align:  center

The following class diagram shows the relationships of the main filter classes:

.. figure:: /images/digraphs/Filters.png
   :align: center
   :alt:   Class diagram of main Filters in Kurento API

   *JJ5 Class diagram of main Filters in Kurento API*

.. digraph:: Filters
   :align: center
   :caption: JJ6 Class diagram of Filters in Kurento API

   size="12,8";
   fontname = "Bitstream Vera Sans"
   fontsize = 8

   node [
        fontname = "Bitstream Vera Sans"
        fontsize = 8
        shape = "record"
         style=filled
        fillcolor = "#E7F2FA"
   ]

   edge [
        fontname = "Bitstream Vera Sans"
        fontsize = 8
        arrowtail = "empty"
        dir = back;
   ]

   "MediaElement" -> "Filter";
   "Filter" -> "ZBarFilter";
   "Filter" -> "FaceOverlayFilter";
   "Filter" -> "GStreamerFilter";



Hubs
====

Hubs are media objects in charge of managing multiple media flows in a pipeline. A Hub has several hub ports where other Media Elements are connected.

**Composite** is a hub that mixes the audio stream of its connected inputs and constructs a grid with the video streams of them.

.. image:: /images/toolbox/Composite.png
   :align:  center

**DispatcherOneToMany** is a Hub that sends a given input to all the connected output HubPorts.

.. image:: /images/toolbox/DispatcherOneToMany.png
   :align:  center

**Dispatcher** is a hub that allows routing between arbitrary input-output HubPort pairs.

.. image:: /images/toolbox/Dispatcher.png
   :align:  center

The following class diagram shows the relationships of the hubs:

.. figure:: /images/digraphs/Hubs.png
   :align: center
   :alt:   Class diagram of main Hubs in Kurento API

   *JJ7 Class diagram of main Hubs in Kurento API*

.. digraph:: Hubs
   :align: center
   :caption: JJ8 Class diagram of Hubs in Kurento API

   size="12,8";
   fontname = "Bitstream Vera Sans"
   fontsize = 8

   node [
        fontname = "Bitstream Vera Sans"
        fontsize = 8
        shape = "record"
         style=filled
        fillcolor = "#E7F2FA"
   ]

   edge [
        fontname = "Bitstream Vera Sans"
        fontsize = 8
        arrowtail = "empty"
        dir = back;
   ]

   "MediaObject" -> "Hub";
   "MediaObject" -> "MediaElement";

   "Hub" -> "HubPort" [headlabel = "*", constraint=false, dir = normal, arrowhead="vee", labelangle=60]

   "MediaElement" -> "HubPort";

   "Hub" -> "Composite";
   "Hub" -> "Dispatcher";
   "Hub" -> "DispatcherOneToMany";
