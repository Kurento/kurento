name: "docker: kurento ci tools"

on:
  # Trigger from other workflow.
  workflow_call:
    inputs:
      jobTool:
        description: "Which tool to build"
        required: true
        type: choice
        default: "kurento-buildpackage"
        options:
          - kurento-buildpackage
          - kurento-ci-buildtools
      jobDistros:
        description: "List of Ubuntu codenames"
        required: true
        # There is no "list" type, so use a raw JSON array and `fromJson()`.
        type: string
        #default: '["xenial", "bionic", "focal"]'
        default: '["focal"]'

  # Manual trigger.
  workflow_dispatch:
    inputs:
      jobTool:
        description: "Which tool to build"
        required: true
        type: choice
        default: "kurento-buildpackage"
        options:
          - kurento-buildpackage
          - kurento-ci-buildtools
      jobDistros:
        description: "List of Ubuntu codenames"
        required: true
        # There is no "list" type, so use a raw JSON array and `fromJson()`.
        type: string
        #default: '["xenial", "bionic", "focal"]'
        default: '["focal"]'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        jobDistro: ${{ fromJson(github.event.inputs.jobDistros) }}
    timeout-minutes: 30
    steps:
      - name: Set JOB_TIMESTAMP
        run: echo "JOB_TIMESTAMP=$(date --utc +%Y%m%d%H%M%S)" >>$GITHUB_ENV

      # Action: https://github.com/marketplace/actions/checkout
      - name: Checkout
        uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3.3.0

      - name: Add ci-scripts/ to PATH
        working-directory: ci-scripts/
        run: echo "$PWD" >>$GITHUB_PATH

      - name: Run job script
        env:
          PUSH_IMAGES: "yes"
          BUILD_ARGS: "UBUNTU_CODENAME=${{ matrix.jobDistro }}"
          TAG: "${{ matrix.jobDistro }}-${{ env.JOB_TIMESTAMP }}"
          # Moving tags, example: "1.2.3", "1.2", "1", "latest"
          EXTRA_TAGS: "${{ matrix.jobDistro }}"
          TAG_COMMIT: "no"
          KURENTO_DOCKERHUB_USERNAME: "${{ secrets.KURENTO_DOCKERHUB_USERNAME }}"
          KURENTO_DOCKERHUB_TOKEN: "${{ secrets.KURENTO_DOCKERHUB_TOKEN }}"
        working-directory: docker/${{ github.event.inputs.jobTool }}/
        run: kurento_container_build.sh

  post-build:
    if: ${{ github.event.inputs.jobTool == "kurento-buildpackage" }}
    needs: build
    uses: ./.github/workflows/docker-kurento-buildpackage.yaml
    with:
      jobTool: kurento-ci-buildtools
      jobDistros: ${{ github.event.inputs.jobDistros }}
